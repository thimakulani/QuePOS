@page "/admin"
@inject IHttpClientService HttpClient
@inject ISnackbar Snackbar
@inject ILocationPickerService LocationPickerService

<MudStack Row="true" Justify="Justify.FlexStart" Class="mb-4">
    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Color="Color.Secondary" OnClick="ShowAddSubStoreForm">
        Add Sub-Store
    </MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ToggleEditMode">
        Edit Store Info
    </MudButton>
</MudStack>

<MudDivider Class="my-4" />

<MudTreeView T="string" ReadOnly>
    <!-- Main Store -->
    <MudTreeViewItem Text="Store">
        <MudPaper Class="mb-4 p-4">
            <dl class="row">
                <dt class="col-sm-4">Store Name</dt>
                <dd class="col-sm-8">@Model.StoreName</dd>
                <dt class="col-sm-4">Address</dt>
                <dd class="col-sm-8">@(string.IsNullOrWhiteSpace(Model.Address) ? "No Address" : Model.Address)</dd>
                <dt class="col-sm-4">Phone</dt>
                <dd class="col-sm-8">@Model.Phone</dd>
                <dt class="col-sm-4">Accept Online Orders</dt>
                <dd class="col-sm-8">@(Model.AcceptOnlineOrders ? "Yes" : "No")</dd>
            </dl>
        </MudPaper>
    </MudTreeViewItem>

    <MudDivider Class="my-4" />

    <!-- Sub-Stores -->
    <MudTreeViewItem Value='"Sub - Store"'>
        @if (!SubStores.Any())
        {
            <MudAlert Severity="Severity.Info" Dense="true" Icon="@Icons.Material.Filled.Note">
                No Sub-Store(s) Linked at the moment
            </MudAlert>
        }
        else
        {
            @foreach (var item in SubStores)
            {
                <MudPaper Class="mb-4 p-4">
                    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                        <MudText Typo="Typo.h6">@item.StoreName</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Variant="Variant.Outlined"
                                       Size="Size.Small"
                                       OnClick="() => { OpenEditSub(item); }" />
                    </MudStack>
                    <dl class="row">
                        <dt class="col-sm-4">Store Name</dt>
                        <dd class="col-sm-8">@item.StoreName</dd>
                        <dt class="col-sm-4">Address</dt>
                        <dd class="col-sm-8">@(string.IsNullOrWhiteSpace(item.Address) ? "No Address" : item.Address)</dd>
                        <dt class="col-sm-4">Phone</dt>
                        <dd class="col-sm-8">@item.Phone</dd>
                        <dt class="col-sm-4">Accept Online Orders</dt>
                        <dd class="col-sm-8">@(item.AcceptOnlineOrders ? "Yes" : "No")</dd>
                    </dl>
                </MudPaper>
            }
        }
    </MudTreeViewItem>
</MudTreeView>

<!-- Edit Main Store Dialog -->
<MudDialog @bind-Visible="IsEditMode" Options="@dialogOptions">
    <TitleContent>EDIT STORE: @EditModel.StoreName</TitleContent>
    <DialogContent>
        <MudBadge style="margin: 10px" OnClick="() => SelectImage()" Color="Color.Primary" Icon="@Icons.Material.Rounded.Edit" Overlap="true" Bordered="true">
            <MudAvatar Variant="Variant.Outlined" Size="Size.Large">
                <MudImage Src="@GetImageSrc(EditModel.ImageUrl)" />
            </MudAvatar>
        </MudBadge>
        <MudFileUpload Hidden="true" @ref="_fileUpload" OnFilesChanged="OnFileSelectedChange" T="IBrowserFile" Accept="image/*">

        </MudFileUpload>
        <EditForm Model="@EditModel" OnValidSubmit="SaveChanges">
            <MudStack Spacing="2">
                <MudTextField Label="Store Name" Variant="Variant.Outlined" @bind-Value="EditModel.StoreName" FullWidth="true" />
                <MudTextField Label="Phone" Variant="Variant.Outlined" @bind-Value="EditModel.Phone" FullWidth="true" />
                <MudSwitch @bind-Value="EditModel.AcceptOnlineOrders" Size="Size.Medium"
                           ThumbIcon="@(EditModel.AcceptOnlineOrders? Icons.Material.Filled.Done : Icons.Material.Filled.Close)"
                           ThumbIconColor="@(EditModel.AcceptOnlineOrders? Color.Success: Color.Error)">
                    Accept Online Orders
                </MudSwitch>
                <MudSwitch @bind-Value="EditModel.AcceptDeliveries" Size="Size.Medium"
                           ThumbIcon="@(EditModel.AcceptDeliveries? Icons.Material.Filled.Done : Icons.Material.Filled.Close)"
                           ThumbIconColor="@(EditModel.AcceptDeliveries? Color.Success: Color.Error)">
                    Accept Delivery
                </MudSwitch>
                @if (EditModel.AcceptDeliveries)
                {
                    <MudAlert NoIcon="true">
                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.AddLocationAlt"
                                       OnClick="() => { _ = LocationPickerClickedForMain(); }"
                                       Variant="Variant.Outlined" />
                        @EditModel.Address
                    </MudAlert>
                }
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">
                    @if (IsLoading)
                    {
                        <MudText>Updating Changes..</MudText>
                        <MudProgressCircular Color="Color.Success" />
                    }
                    else
                    {
                        <MudText>
                            Save Changes
                        </MudText>
                    }

                </MudButton>
            </MudStack>
        </EditForm>
    </DialogContent>
</MudDialog>

<!-- Add/Edit Sub-Store Dialog -->
<MudDialog @bind-Visible="IsAddingSubStore" Options="@dialogOptions">
    <TitleContent>@(SubStoreModel.Id == Guid.Empty ? "ADD A SUB-STORE" : $"EDIT: {SubStoreModel.StoreName.ToUpper()}")</TitleContent>
    <DialogContent>
        <MudBadge style="margin: 10px" OnClick="() => SelectSubImage()" Color="Color.Primary" Icon="@Icons.Material.Rounded.Edit" Overlap="true" Bordered="true">
            <MudAvatar Variant="Variant.Outlined" Size="Size.Large">
                <MudImage Src="@GetImageSrc(SubStoreModel.ImageUrl)" />
            </MudAvatar>
        </MudBadge>
        <MudFileUpload Hidden="true" @ref="_subfileUpload" OnFilesChanged="OnFileSubSelectedChange" T="IBrowserFile" Accept="image/*">

        </MudFileUpload>
        <EditForm Model="@SubStoreModel" OnValidSubmit="SaveSubStore">
            <MudStack Spacing="2">
                <MudTextField Label="Store Name" Variant="Variant.Outlined" @bind-Value="SubStoreModel.StoreName" FullWidth="true" />
                <MudTextField Label="Phone" Variant="Variant.Outlined" @bind-Value="SubStoreModel.Phone" FullWidth="true" />
                <MudSwitch @bind-Value="SubStoreModel.AcceptOnlineOrders" Size="Size.Medium"
                           ThumbIcon="@(SubStoreModel.AcceptOnlineOrders? Icons.Material.Filled.Done : Icons.Material.Filled.Close)"
                           ThumbIconColor="@(SubStoreModel.AcceptOnlineOrders? Color.Success: Color.Error)">
                    Accept Online Orders
                </MudSwitch>
                <MudSwitch @bind-Value="SubStoreModel.AcceptDeliveries" Size="Size.Medium"
                           ThumbIcon="@(SubStoreModel.AcceptDeliveries? Icons.Material.Filled.Done : Icons.Material.Filled.Close)"
                           ThumbIconColor="@(SubStoreModel.AcceptDeliveries? Color.Success: Color.Error)">
                    Accept Delivery
                </MudSwitch>
                @if (SubStoreModel.AcceptDeliveries)
                {
                    <MudAlert NoIcon="true">
                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.AddLocationAlt"
                                       OnClick="() => { _ = LocationPickerClickedForSubStore(); }"
                                       Variant="Variant.Outlined" />
                        @SubStoreModel.Address
                    </MudAlert>
                }
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">
                    @if (IsLoading)
                    {
                        <MudText>Processing..</MudText>
                        <MudProgressCircular Color="Color.Success" />
                    }
                    else
                    {
                        if (SubStoreModel.Id == Guid.Empty)
                        {
                            <MudText>
                                Save Changes
                            </MudText>
                        }
                        else
                        {
                            <MudText>
                                Update Changes
                            </MudText>
                        }
                    }
                </MudButton>
            </MudStack>
        </EditForm>
    </DialogContent>
</MudDialog>

@code {
    private Store Model { get; set; } = new();
    private Store EditModel { get; set; } = new();
    private Store SubStoreModel { get; set; } = new();
    public List<Store> SubStores = [];
    private bool IsEditMode = false;
    private bool IsAddingSubStore = false;
    private DialogOptions dialogOptions = new() { FullWidth = true };
    private bool IsLoading = false;
    protected override async Task OnInitializedAsync()
    {
        await LoadStoreData();
    }
    private MudFileUpload<IBrowserFile> _fileUpload;
    private MudFileUpload<IBrowserFile> _subfileUpload;
    private async Task LoadStoreData()
    {
        try
        {
            var stor = await HttpClient.GetAsync<Store>("/api/store");
            Model = stor;
            SubStores = stor.SubStores.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
    private string selectedFile;
    private async void OnFileSelectedChange(InputFileChangeEventArgs args)
    {
        if (args.File != null)
        {
            EditModel.ImageUrl = await ConvertFileToBase64(args.File);
            StateHasChanged();
        }
    }
    private async void OnFileSubSelectedChange(InputFileChangeEventArgs args)
    {
        if (args.File != null)
        {
            SubStoreModel.ImageUrl = await ConvertFileToBase64(args.File);
            StateHasChanged();
        }
    }
    private async Task<string> ConvertFileToBase64(IBrowserFile file)
    {
        using var stream = file.OpenReadStream();
        using var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);
        return Convert.ToBase64String(memoryStream.ToArray());
    }
    private void ToggleEditMode()
    {
        EditModel = new Store
        {
            Id = Model.Id,
            StoreName = Model.StoreName,
            Address = Model.Address,
            Phone = Model.Phone,
            AcceptOnlineOrders = Model.AcceptOnlineOrders,
            AcceptDeliveries = Model.AcceptDeliveries,
            Latitude = Model.Latitude,
            Longitude = Model.Longitude,
            ImageUrl = Model.ImageUrl,
            StoreUserId = Model.StoreUserId,
            IsActive = Model.IsActive,
            ParentStoreId = Model.ParentStoreId,
            SubStores = Model.SubStores
        };
        selectedFile = string.Empty;
        IsEditMode = true;
    }

    private async Task SaveChanges()
    {
        try
        {
            IsLoading = true;
            var updated = await HttpClient.PutAsync<Store>($"/api/store/{EditModel.Id}", EditModel);
            Model = updated;
            Snackbar.Add("Store updated successfully.", Severity.Success);
            IsEditMode = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void ShowAddSubStoreForm()
    {
        SubStoreModel = new Store { ParentStoreId = Model.Id };
        IsAddingSubStore = true;
    }

    private async Task SaveSubStore()
    {
        try
        {

            IsLoading = true;
            if (!string.IsNullOrEmpty(selectedFile))
            {
                SubStoreModel.ImageUrl = selectedFile;
            }
            if (SubStoreModel.Id != Guid.Empty)
            {

                var updated = await HttpClient.PutAsync<Store>($"/api/store/{SubStoreModel.Id}", SubStoreModel);
                for (int i = 0; i < SubStores.Count; i++)
                {
                    if (SubStores[i].Id == updated.Id)
                    {
                        SubStores[i] = updated;
                        break;
                    }
                }
                Snackbar.Add("Sub-store has been updated successfully.", Severity.Success);
            }
            else
            {
                var newSubStore = await HttpClient.PostAsync<Store>("/api/store", SubStoreModel);
                SubStores.Add(newSubStore);
                Snackbar.Add("Sub-store created successfully.", Severity.Success);
            }



            IsAddingSubStore = false;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }
    private void OpenEditSub(Store store)
    {
        SubStoreModel = new Store
        {
            Id = store.Id,
            StoreName = store.StoreName,
            Address = store.Address,
            Phone = store.Phone,
            AcceptOnlineOrders = store.AcceptOnlineOrders,
            AcceptDeliveries = store.AcceptDeliveries,
            Latitude = store.Latitude,
            Longitude = store.Longitude,
            ImageUrl = store.ImageUrl,
            StoreUserId = store.StoreUserId,
            IsActive = store.IsActive,
            ParentStoreId = store.ParentStoreId,
            SubStores = store.SubStores
        };
        selectedFile = string.Empty;
        IsAddingSubStore = true;
    }
    private async void SelectSubImage()
    {
        await _subfileUpload.OpenFilePickerAsync();
    }
    private async void SelectImage()
    {
        await _fileUpload.OpenFilePickerAsync();
    }

    private async Task LocationPickerClickedForMain()
    {
        var address = await LocationPickerService.GetAddress();
        EditModel.Address = address.Address;
        EditModel.Latitude = address.Latitude;
        EditModel.Longitude = address.Longitude;
    }

    private string GetImageSrc(string imageData)
    {
        if (string.IsNullOrWhiteSpace(imageData))
            return "/images/placeholder.png"; // Change to your default image path

        if (imageData.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
            imageData.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
            return imageData;

        // If not a URL, assume it’s base64
        return $"data:image/png;base64,{imageData}";
    }


    private async Task LocationPickerClickedForSubStore()
    {
        var address = await LocationPickerService.GetAddress();
        SubStoreModel.Address = address.Address;
        SubStoreModel.Latitude = address.Latitude;
        SubStoreModel.Longitude = address.Longitude;
    }

}
