@page "/users/index"

<MudCard>
    <MudCardContent>
        <MudButton Color="Color.Primary" OnClick="OpenCreateDialog">Add User</MudButton>
        <MudTable Items="@users" Striped="true" Bordered="true" Hover="true">
            <HeaderContent>
                <MudTh>First Name</MudTh>
                <MudTh>Last Name</MudTh>
                <MudTh>Phone Number</MudTh>
                <MudTh>Created At</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="First Name">@context.FirstName</MudTd>
                <MudTd DataLabel="Last Name">@context.LastName</MudTd>
                <MudTd DataLabel="Phone Number">@context.PhoneNumber</MudTd>
                <MudTd DataLabel="Created At">@context.CreatedAt.ToString("yyyy-MM-dd")</MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Outlined.Edit" Color="Color.Primary" OnClick="() => OpenEditDialog(context)" />
                    <MudIconButton Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="() => DeleteUser(context.Id)" />
                </MudTd>
            </RowTemplate>
        </MudTable>

    </MudCardContent>
</MudCard>

<!-- Create/Edit User Dialog -->
<MudDialog @bind-IsOpen="dialogOpen" MaxWidth="MaxWidth.Small">
    <TitleContent>@(selectedUser.Id == 0 ? "CREATE USER" : "EDIT USER")</TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="selectedUser.FirstName" Label="First Name" Required="true" />
        <MudTextField @bind-Value="selectedUser.LastName" Label="Last Name" Required="true" />
        <MudTextField @bind-Value="selectedUser.PhoneNumber" Label="Phone Number" Required="true" />
        @* <MudTextField @bind-Value="selectedUser.Email" Label="Email" Required="true" /> *@
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="SaveUser" Color="Color.Primary">Save</MudButton>
        <MudButton OnClick="CloseDialog" Color="Color.Secondary">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<StoreUser> users = new List<StoreUser>();
    private bool dialogOpen = false;
    private StoreUser selectedUser = new StoreUser();
    @inject IHttpClientService HttpClientService;
    @inject ISnackbar Snackbar;

    protected override async Task OnInitializedAsync()
    {
        try
        {

            users = await HttpClientService.GetAsync<List<StoreUser>>("/api/StoreUser/users");

        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An unexpected error occurred: {ex.Message}", Severity.Error);
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void OpenCreateDialog()
    {
        selectedUser = new StoreUser();
        dialogOpen = true;
    }

    private void OpenEditDialog(StoreUser user)
    {
        selectedUser = new StoreUser
            {
                Id = user.Id,
                FirstName = user.FirstName,
                LastName = user.LastName,
                PhoneNumber = user.PhoneNumber,
                //Email = user.Email,
                CreatedAt = user.CreatedAt
            };
        dialogOpen = true;
    }

    private void CloseDialog()
    {
        dialogOpen = false;
    }

    private async Task SaveUser()
    {
        if (selectedUser.Id == 0)  // Create new user
        {
            var response = await HttpClientService.PostAsync<StoreUser>("/api/users", selectedUser);

            users.Add(response);

        }
        else  // Update existing user
        {
            var response = await HttpClientService.PutAsync<StoreUser>($"/api/users/{selectedUser.Id}", selectedUser);
            var index = users.FindIndex(u => u.Id == selectedUser.Id);
            users[index] = selectedUser;
        }

        CloseDialog();
    }

    private async Task DeleteUser(int userId)
    {
        await HttpClientService.DeleteAsync($"/api/users/{userId}");
        users.RemoveAll(u => u.Id == userId);
    }
}
